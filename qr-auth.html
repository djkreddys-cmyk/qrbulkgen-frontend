<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Account — QRBulkGen</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">

<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between">
    <a href="index.html" class="text-xl font-bold text-indigo-600">QRBulkGen</a>
  </div>
</header>

<div class="flex-grow flex items-center justify-center px-4">
  <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-8">

<h2 id="title" class="text-2xl font-bold text-center mb-6">Create Account</h2>
<p id="msg" class="text-center text-sm mb-4"></p>

<input id="name" type="text" placeholder="Your Name" class="w-full border rounded-lg px-4 py-3 mb-3" />
<input id="email" type="email" placeholder="Email" class="w-full border rounded-lg px-4 py-3 mb-3" />
<input id="password" type="password" placeholder="Password" class="w-full border rounded-lg px-4 py-3 mb-3" />

<div id="forgotBox" class="text-right mb-3 hidden">
  <button onclick="openReset()" class="text-sm text-indigo-600 hover:underline">Forgot Password?</button>
</div>

<button id="mainBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg mb-4 hover:bg-indigo-700">Register</button>

<p class="text-center text-sm">
  <span id="switchText">Already registered?</span>
  <button onclick="toggleMode()" class="text-indigo-600 font-semibold">Login</button>
</p>

  </div>
</div>

<script>
const API="https://qrbulkgen-backend-production.up.railway.app/api";

let isLogin=false;

const nameEl=document.getElementById("name");
const emailEl=document.getElementById("email");
const passwordEl=document.getElementById("password");
const title=document.getElementById("title");
const mainBtn=document.getElementById("mainBtn");
const switchText=document.getElementById("switchText");
const forgotBox=document.getElementById("forgotBox");
const msg=document.getElementById("msg");

function show(t,color="red"){
 msg.innerText=t;
 msg.className="text-center text-sm mb-4 text-"+color+"-600";
}

function toggleMode(){
 isLogin=!isLogin;

 if(isLogin){
  title.innerText="Login";
  mainBtn.innerText="Login";
  nameEl.style.display="none";
  forgotBox.classList.remove("hidden");
  switchText.innerText="New here?";
  document.querySelector("#switchText + button").innerText="Register";
 }else{
  title.innerText="Create Account";
  mainBtn.innerText="Register";
  nameEl.style.display="block";
  forgotBox.classList.add("hidden");
  switchText.innerText="Already registered?";
  document.querySelector("#switchText + button").innerText="Login";
 }
}

mainBtn.onclick=async()=>{
 const email=emailEl.value.trim();
 const password=passwordEl.value.trim();

 if(isLogin){
   const r=await fetch(API+"/login",{
     method:"POST",
     headers:{'Content-Type':'application/json'},
     body:JSON.stringify({email,password})
   });

   if(r.status!==200){
     show("Invalid login");
     return;
   }

   const data=await r.json();
   localStorage.setItem("token",data.token);

   // ONLY REDIRECT HERE (NO reload)
   const after = localStorage.getItem("afterLogin");
   localStorage.removeItem("afterLogin");

   window.location = after || "qr-dashboard.html";
 }
 else{
   const name=nameEl.value.trim();
   if(!name||!email||!password){
     show("Fill all fields");
     return;
   }

   const r=await fetch(API+"/register",{
     method:"POST",
     headers:{'Content-Type':'application/json'},
     body:JSON.stringify({name,email,password})
   });

   show(await r.text(),"green");
 }
};
</script>
<!-- RESET PASSWORD MODAL -->
<div id="resetModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-xl">

    <h3 class="text-xl font-bold mb-4 text-center">Reset Password</h3>

    <div class="relative mb-3">
      <input id="resetEmail" type="email" placeholder="Registered Email"
        class="w-full border rounded-lg px-4 py-3 pr-10">

      <span id="emailStatus" class="absolute right-3 top-3 text-xl"></span>
    </div>

    <input id="resetPassword" type="password" placeholder="New Password"
      class="w-full border rounded-lg px-4 py-3 mb-4 opacity-50" disabled>

    <button id="updatePasswordBtn"
      class="w-full bg-indigo-600 text-white py-3 rounded-lg mb-2">
      Update Password
    </button>

    <button id="cancelReset"
      class="w-full text-gray-500">
      Cancel
    </button>

  </div>
</div>
</body>
</html>
<script>

const resetModal = document.getElementById("resetModal");
const resetEmail = document.getElementById("resetEmail");
const resetPasswordInput = document.getElementById("resetPassword");
const emailStatus = document.getElementById("emailStatus");
const updateBtn = document.getElementById("updatePasswordBtn");
const cancelBtn = document.getElementById("cancelReset");

let emailValid = false;

// OPEN MODAL
function forgotPassword(){
  resetModal.classList.remove("hidden");
  resetModal.classList.add("flex");
  resetEmail.value="";
  resetPasswordInput.value="";
  resetPasswordInput.disabled=true;
  resetPasswordInput.classList.add("opacity-50");
  emailStatus.innerHTML="";
}

// CLOSE MODAL
cancelBtn.onclick = () => {
  resetModal.classList.add("hidden");
  resetModal.classList.remove("flex");
};

// CHECK EMAIL LIVE
resetEmail.addEventListener("input", async () => {

  const email = resetEmail.value.trim();

  if(email.length < 5){
    emailStatus.innerHTML="";
    resetPasswordInput.disabled=true;
    resetPasswordInput.classList.add("opacity-50");
    return;
  }

  const r = await fetch(API+"/check-email",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email})
  });

  const data = await r.json();

  if(data.exists){
    emailStatus.innerHTML="✔";
    emailStatus.className="absolute right-3 top-3 text-xl text-green-500";
    resetPasswordInput.disabled=false;
    resetPasswordInput.classList.remove("opacity-50");
    emailValid=true;
  }else{
    emailStatus.innerHTML="✖";
    emailStatus.className="absolute right-3 top-3 text-xl text-red-500";
    resetPasswordInput.disabled=true;
    resetPasswordInput.classList.add("opacity-50");
    emailValid=false;
  }
});

// UPDATE PASSWORD
updateBtn.onclick = async () => {

  if(!emailValid){
    alert("Please enter registered email");
    return;
  }

  const email = resetEmail.value.trim();
  const newPassword = resetPasswordInput.value.trim();

  if(newPassword.length < 4){
    alert("Password must be at least 4 characters");
    return;
  }

  const r = await fetch(API+"/reset-password",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email,newPassword})
  });

  const msg = await r.text();
  alert(msg);

  if(r.ok){
    resetModal.classList.add("hidden");
    resetModal.classList.remove("flex");
  }
};

</script>
