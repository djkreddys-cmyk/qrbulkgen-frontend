<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bulk QR Upload — QRBulkGen</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="js/auth.js"></script>
<style>
.qrTab{padding:10px 14px;border-radius:10px;color:#374151;white-space:nowrap}
.qrTab:hover{background:#eef2ff;color:#4f46e5}
.qrTab.active{background:#4f46e5;color:white}
</style>
</head>
<body class="bg-gray-100">

<header class="bg-white shadow sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
<a id="logoLink" href="qr-dashboard.html" class="text-xl font-bold text-indigo-600">QRBulkGen</a>
<div class="flex items-center gap-6">
<div id="navLinks" class="hidden md:flex gap-6">
<a href="qr-single.html">Generate QR</a>
<a href="qr-bulk.html">Bulk Upload</a>
<a href="qr-dashboard.html">Dashboard</a>
</div>
<div id="navUser"></div>
</div>
</div>
</header>

<!-- TYPE SLIDER -->
<div class="bg-white border-b sticky top-[72px] z-40">
<div class="max-w-7xl mx-auto flex items-center px-2">
<button id="leftArrow" onclick="slideTabs(-1)" class="p-2 text-xl">◀</button>
<div id="tabsWrapper" class="overflow-hidden flex-1">
<div id="tabs" class="flex gap-4 py-3 transition-all duration-300">
<button class="qrTab active" onclick="selectType('text',this)">Text</button>
<button class="qrTab" onclick="selectType('url',this)">Website</button>
<button class="qrTab" onclick="selectType('whatsapp',this)">WhatsApp</button>
<button class="qrTab" onclick="selectType('wifi',this)">WiFi</button>
<button class="qrTab" onclick="selectType('upi',this)">UPI</button>
<button class="qrTab" onclick="selectType('email',this)">Email</button>
<button class="qrTab" onclick="selectType('phone',this)">Phone</button>
<button class="qrTab" onclick="selectType('location',this)">Location</button>
<button class="qrTab" onclick="selectType('vcard',this)">Business Card</button>
<button class="qrTab" onclick="selectType('menu',this)">Restaurant Menu</button>
<button class="qrTab" onclick="selectType('product',this)">Product Label</button>
<button class="qrTab" onclick="selectType('ticket',this)">Event Ticket</button>
</div>
</div>
<button id="rightArrow" onclick="slideTabs(1)" class="p-2 text-xl">▶</button>
</div>
</div>

<div class="max-w-7xl mx-auto p-6 grid md:grid-cols-2 gap-8">

<!-- LEFT BOX -->
<div class="bg-white rounded-2xl shadow p-6">
<h2 class="text-xl font-semibold mb-4">Selected: <span id="selectedType">Text</span> QR</h2>
<div id="columnHint"
class="text-xs bg-blue-50 text-blue-700 p-3 rounded-lg mb-4">
Required columns: value, name
</div>
<!-- STEP 1 -->
<button onclick="downloadSample()"
class="bg-gray-800 text-white px-4 py-2 rounded-xl w-full mb-4">
Step 1: Download Sample Excel
</button>

<!-- STEP 2 -->
<label class="text-xs text-gray-500">Step 2: Upload Excel Data File</label>
<input type="file" id="excelFile" accept=".xlsx"
class="border p-2 rounded-xl w-full mb-4">

<!-- STEP 3 -->
<label class="text-xs text-gray-500">Step 3: Upload Logo (Optional)</label>
<input type="file" id="logoFile" accept="image/*"
class="border p-2 rounded-xl w-full mb-4">

<!-- STEP 4 -->
<button onclick="loadPreview()"
class="bg-indigo-600 text-white px-4 py-2 rounded-xl w-full mb-4">
Step 4: Load Data
</button>

<hr class="my-4">
<h3 class="font-semibold mb-3">Customization</h3>
<div class="grid grid-cols-3 gap-3 items-end">
<input type="color" id="qrColor" value="#000000" class="h-10" oninput="updatePreview()">
<input type="color" id="bgColor" value="#ffffff" class="h-10" oninput="updatePreview()">
<select id="qrStyle" class="border rounded h-10 px-2" onchange="updatePreview()">
<option value="square">Square</option>
<option value="dots">Dots</option>
<option value="rounded">Rounded</option>
<option value="classy">Classy</option>
<option value="extra-rounded">Extra Rounded</option>
</select>
</div>
</div>

<!-- RIGHT BOX -->
<div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center">
<h2 class="text-xl font-semibold mb-4">Live Preview</h2>
<div id="preview" class="p-6 bg-white rounded-xl"></div>
<div id="errorBox"
class="hidden w-full mb-4 bg-red-50 text-red-700 p-3 rounded-lg text-sm">
</div>
<div class="flex gap-3 mt-4">
<button onclick="prevRow()" class="border px-4 py-2 rounded-lg">◀ Previous</button>
<span id="rowIndicator" class="text-sm text-gray-500 self-center">Row 0 / 0</span>
<button onclick="nextRow()" class="border px-4 py-2 rounded-lg">Next ▶</button>
</div>
<div class="grid grid-cols-2 gap-3 mt-6 w-full">
<button onclick="generateZip()" class="bg-green-600 text-white py-3 rounded-xl">Download ZIP</button>
<button onclick="saveDashboard()" class="bg-indigo-600 text-white py-3 rounded-xl">Save</button>
</div>
</div>
</div>

<script>
let currentType='text';
let rows=[];
let logoURL=null;
let qr=null;
let currentIndex=0;

function selectType(t,el){
  currentType=t;

  // reset previous upload
  rows=[];
  currentIndex=0;
  document.getElementById('preview').innerHTML='';
  document.getElementById('rowIndicator').innerText='Row 0 / 0';
  document.getElementById('errorBox').classList.add('hidden');
  document.getElementById('excelFile').value='';

  document.getElementById('selectedType').innerText=t.charAt(0).toUpperCase()+t.slice(1);
  document.querySelectorAll('.qrTab').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');

  updateColumnHint();
}

let tabPosition=0;
function slideTabs(d){
 const w=document.getElementById('tabsWrapper');
 const t=document.getElementById('tabs');
 const m=t.scrollWidth-w.clientWidth;
 tabPosition+=d*200;
 if(tabPosition<0)tabPosition=0;
 if(tabPosition>m)tabPosition=m;
 t.style.transform='translateX(-'+tabPosition+'px)';
}

document.getElementById('logoFile').addEventListener('change',function(e){
 const f=e.target.files[0];
 if(f)logoURL=URL.createObjectURL(f);
 updatePreview();
});

function downloadSample(){
 var data=[]; var filename='sample.xlsx';
 if(currentType==='text'){data=[{value:'Hello World',name:'text1'}];filename='sample_text.xlsx';}
 else if(currentType==='url'){data=[{value:'https://google.com',name:'web1'}];filename='sample_website.xlsx';}
 else if(currentType==='phone'){data=[{value:'9876543210',name:'call1'}];filename='sample_phone.xlsx';}
 else if(currentType==='email'){data=[{value:'demo@gmail.com',name:'mail1'}];filename='sample_email.xlsx';}
 else if(currentType==='whatsapp'){data=[{phone:'9876543210',msg:'Welcome',name:'wa1'}];filename='sample_whatsapp.xlsx';}
 else if(currentType==='wifi'){data=[{ssid:'OfficeNet',password:'12345678',name:'wifi1'}];filename='sample_wifi.xlsx';}
 else if(currentType==='upi'){data=[{upi:'shop@upi',amount:'100',name:'upi1'}];filename='sample_upi.xlsx';}
 else if(currentType==='location'){data=[{address:'Vijayawada',name:'loc1'}];filename='sample_location.xlsx';}
 else if(currentType==='vcard'){data=[{name:'Ramesh',org:'ABC Pvt Ltd',tel:'9999999999'}];filename='sample_vcard.xlsx';}
 else if(currentType==='menu'){data=[{url:'https://restaurantmenu.com',name:'menu1'}];filename='sample_menu.xlsx';}
 else if(currentType==='product'){data=[{product:'Rice Bag',code:'SKU123',name:'prod1'}];filename='sample_product.xlsx';}
 else if(currentType==='ticket'){data=[{event:'Music Fest',seat:'A12',date:'12-10-2026',name:'ticket1'}];filename='sample_ticket.xlsx';}

 const ws=XLSX.utils.json_to_sheet(data);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,'QR');
 XLSX.writeFile(wb,filename);
}

async function loadPreview(){
 const file=document.getElementById('excelFile').files[0];
 if(!file){alert('Upload excel');return;}
 const buf=await file.arrayBuffer();
 const wb=XLSX.read(buf);
 rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

if(validateRows()){
 currentIndex=0;
 updatePreview();
}
}
function buildData(r){
 if(currentType==='text') return r.value||'';
 if(currentType==='url') return r.value||'';

 if(currentType==='phone') return 'tel:'+(r.value||'');
 if(currentType==='email') return 'mailto:'+(r.value||'');

 if(currentType==='whatsapp')
  return 'https://wa.me/'+(r.phone||'')+'?text='+encodeURIComponent(r.msg||'');

 if(currentType==='wifi')
  return 'WIFI:T:WPA;S:'+(r.ssid||'')+';P:'+(r.password||'')+';;';

 if(currentType==='upi')
  return 'upi://pay?pa='+(r.upi||'')+'&am='+(r.amount||'');

 if(currentType==='location')
  return 'https://www.openstreetmap.org/search?query='+encodeURIComponent(r.address||'');

 if(currentType==='vcard')
  return 'BEGIN:VCARD\\nVERSION:3.0\\nFN:'+(r.name||'')+'\\nORG:'+(r.org||'')+'\\nTEL:'+(r.tel||'')+'\\nEND:VCARD';

 if(currentType==='menu') return r.url||'';

 if(currentType==='product')
  return 'Product:'+(r.product||'')+'\\nCode:'+(r.code||'');

 if(currentType==='ticket')
  return 'Event:'+(r.event||'')+'\\nSeat:'+(r.seat||'')+'\\nDate:'+(r.date||'');

 return '';
}

function updatePreview(){
 if(rows.length===0){
 document.getElementById('preview').innerHTML=
 '<div class="text-gray-400 text-sm">Load Excel data to preview QR</div>';
 return;
}
 if(currentIndex<0)currentIndex=0;
 if(currentIndex>=rows.length)currentIndex=rows.length-1;
 var r=rows[currentIndex];
 document.getElementById('preview').innerHTML='';
 qr=new QRCodeStyling({width:260,height:260,data:buildData(r),image:logoURL,dotsOptions:{color:qrColor.value,type:qrStyle.value},backgroundOptions:{color:bgColor.value}});
 qr.append(document.getElementById('preview'));
 document.getElementById('rowIndicator').innerText='Row '+(currentIndex+1)+' / '+rows.length;
}

async function generateZip(){
  if(!validateRows()){
 alert("Fix Excel errors before downloading ZIP");
 return;
}
 if(rows.length===0){alert('Load excel first');return;}
 const zip=new JSZip();
 for(let i=0;i<rows.length;i++){
  const r=rows[i];
  const q=new QRCodeStyling({width:800,height:800,data:buildData(r),image:logoURL,dotsOptions:{color:qrColor.value,type:qrStyle.value},backgroundOptions:{color:bgColor.value}});
  const blob=await q.getRawData('png');
  zip.file((r.name||('qr_'+(i+1)))+'.png',blob);
 }
 const content=await zip.generateAsync({type:'blob'});
 saveAs(content,'QR_CODES.zip');
}
function saveDashboard(){
 if(!qr){alert('Load preview first');return;}
 qr.getRawData('png').then(function(blob){
  const r=new FileReader();
  r.onload=function(){
   let saved=JSON.parse(localStorage.getItem('savedQRs')||'[]');
   saved.push({name:'BulkPreview',date:new Date().toLocaleString(),data:r.result});
   localStorage.setItem('savedQRs',JSON.stringify(saved));
   alert('Saved to dashboard');
  };
  r.readAsDataURL(blob);
 });
}

function nextRow(){
 if(rows.length===0)return;
 currentIndex++;
 if(currentIndex>=rows.length)currentIndex=rows.length-1;
 updatePreview();
}

function prevRow(){
 if(rows.length===0)return;
 currentIndex--;
 if(currentIndex<0)currentIndex=0;
 updatePreview();
}
function updateColumnHint(){

 let hint="value, name";

 if(currentType==='whatsapp') hint="phone, msg, name";
 else if(currentType==='wifi') hint="ssid, password, name";
 else if(currentType==='upi') hint="upi, amount, name";
 else if(currentType==='location') hint="address, name";
 else if(currentType==='vcard') hint="name, org, tel";
 else if(currentType==='menu') hint="url, name";
 else if(currentType==='product') hint="product, code, name";
 else if(currentType==='ticket') hint="event, seat, date, name";

 document.getElementById("columnHint").innerText="Required columns: "+hint;
}
function validateRows(){

 let required=["value"];

 if(currentType==='whatsapp') required=["phone","msg"];
 else if(currentType==='wifi') required=["ssid","password"];
 else if(currentType==='upi') required=["upi"];
 else if(currentType==='location') required=["address"];
 else if(currentType==='vcard') required=["name","tel"];
 else if(currentType==='menu') required=["url"];
 else if(currentType==='product') required=["product","code"];
 else if(currentType==='ticket') required=["event","seat","date"];

 let errors=[];

 rows.forEach((r,i)=>{
   required.forEach(col=>{
     if(!r[col] || String(r[col]).trim()==='')
     errors.push(`Row ${i+1} missing "${col}"`);
   });
 });

 const box=document.getElementById("errorBox");

 if(errors.length){
   box.classList.remove("hidden");
   box.innerHTML=errors.join("<br>");
   return false;
 }else{
   box.classList.add("hidden");
   return true;
 }
}

</script>
</body>
</html>






