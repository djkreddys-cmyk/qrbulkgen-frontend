<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Generate QR — QRBulkGen</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
<script src="js/auth.js"></script>
<script src="js/qr-engine-v2.js"></script>
<style>
.qrTab{padding:10px 14px;border-radius:10px;color:#374151;white-space:nowrap}
.qrTab:hover{background:#eef2ff;color:#4f46e5}
.qrTab.active{background:#4f46e5;color:white}
.btnGen{width:100%;background:#4f46e5;color:white;padding:12px;border-radius:12px}
#tabsWrapper{
  overflow:hidden;
  height:52px;
  display:flex;
  align-items:center;
}
</style>
</head>
<body class="bg-gray-100">

<!-- NAVBAR -->
<header class="bg-white shadow sticky top-0 z-50">
<div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">

<a id="logoLink" href="qr-dashboard.html" class="text-xl font-bold text-indigo-600">
QRBulkGen
</a>

<div class="flex items-center gap-6">
<div id="navLinks" class="hidden md:flex gap-6">
<a href="qr-single.html">Generate QR</a>
<a href="qr-bulk.html">Bulk Upload</a>
<a href="qr-dashboard.html">Dashboard</a>
</div>
<div id="navUser"></div>
</div>

</div>
</header>

<!-- TYPE SLIDER -->
<div class="bg-white border-b sticky top-[72px] z-40">
<div class="max-w-7xl mx-auto flex items-stretch px-2">

<button id="leftArrow" onclick="slideTabs(-1)" class="p-2 text-xl">◀</button>

<div id="tabsWrapper" class="overflow-hidden flex-1">
  <div id="tabs" class="flex gap-4 py-3 transition-all duration-300 w-max"></div>
</div>

<button id="rightArrow" onclick="slideTabs(1)" class="p-2 text-xl">▶</button>

</div>
</div>

<!-- CONTENT -->
<div class="max-w-7xl mx-auto p-6 grid md:grid-cols-2 gap-8">

<div id="formArea" class="bg-white rounded-2xl shadow p-6"></div>

<div class="bg-white rounded-2xl shadow p-6 flex flex-col items-center w-full">
<h2 class="text-xl font-semibold mb-4">Live Preview</h2>

<div id="qrcode" class="p-6 bg-white rounded-xl"></div>
<div class="grid grid-cols-2 gap-3 mt-4 w-full">

<button onclick="openDownloadModal()"
class="bg-green-600 text-white py-3 rounded-xl w-full">
Download
</button>
<button onclick="openSaveModal()"
class="bg-indigo-600 text-white py-3 rounded-xl w-full">
Save
</button>
</div>
</div>
</div>

<script>
let currentType="text";
let qrCode=null;
let qrSettings={color:"#000000",bg:"#ffffff",style:"square",logo:null};
let tabPosition = 0;

function renderTabs(){
const container=document.getElementById("tabs");
container.innerHTML="";

Object.keys(QR_TYPES).forEach((type,i)=>{
 const btn=document.createElement("button");
 btn.className="qrTab"+(i===0?" active":"");
 btn.innerText=QR_TYPES[type].label;
 btn.onclick=()=>selectType(type,btn);
 container.appendChild(btn);
});
}
/* ---------- SLIDER ---------- */
function slideTabs(dir){

  const wrapper = document.getElementById("tabsWrapper");
  const tabs = document.getElementById("tabs");
  const left = document.getElementById("leftArrow");
  const right = document.getElementById("rightArrow");

  const viewWidth = wrapper.clientWidth;
  const maxScroll = Math.max(0, tabs.scrollWidth - viewWidth);

  tabPosition += dir * (viewWidth * 0.8);

  if(tabPosition < 0) tabPosition = 0;
  if(tabPosition > maxScroll) tabPosition = maxScroll;

  tabs.style.transform = `translateX(-${tabPosition}px)`;

  // arrow visibility
  left.style.visibility = tabPosition <= 0 ? "hidden":"visible";
  right.style.visibility = tabPosition >= maxScroll-5 ? "hidden":"visible";
}

/* ---------- TAB SWITCH ---------- */
function selectType(type,el){

/* reset customization when changing QR type */
qrSettings={
color:"#000000",
bg:"#ffffff",
style:"square",
logo:null
};

currentType=type;
document.querySelectorAll(".qrTab").forEach(t=>t.classList.remove("active"));
el.classList.add("active");
renderForm();
setTimeout(()=>slideTabs(0),200);

/* clear preview */
document.getElementById("qrcode").innerHTML="";
setTimeout(generateQR,100);
}

/* ---------- FORM ---------- */
function renderForm(){
const a=document.getElementById("formArea");
const def=QR_TYPES[currentType];

let html=`<h2 class="text-xl font-bold mb-4">${def.label} QR</h2>`;

def.fields.forEach(f=>{
 html += `<input id="${f.id}" placeholder="${f.label}" class="w-full border rounded-xl p-3 mb-3" oninput="generateQR()">`;
});

a.innerHTML=html + qrCustomizationUI();
}

function qrCustomizationUI(){
return `
<div class="border-t mt-4 pt-4">

<h3 class="font-semibold mb-3">QR Customization</h3>

<div class="grid grid-cols-2 md:grid-cols-5 gap-3 items-end">

<div>
<label class="text-xs">QR Color</label>
<input type="color" id="qrColor" value="${qrSettings.color}"
class="w-full h-10" oninput="updateQRSettings()">
</div>

<div>
<label class="text-xs">Background</label>
<input type="color" id="bgColor" value="${qrSettings.bg}"
class="w-full h-10" oninput="updateQRSettings()">
</div>

<div>
<label class="text-xs">Style</label>
<select id="qrStyle"
class="w-full border rounded-lg h-10 px-2"
onchange="updateQRSettings()">
<option value="square" ${qrSettings.style=="square"?"selected":""}>Square</option>
<option value="dots" ${qrSettings.style=="dots"?"selected":""}>Dots</option>
<option value="rounded" ${qrSettings.style=="rounded"?"selected":""}>Rounded</option>
<option value="classy" ${qrSettings.style=="classy"?"selected":""}>Classy</option>
<option value="classy-rounded" ${qrSettings.style=="classy-rounded"?"selected":""}>Classy Rounded</option>
<option value="extra-rounded" ${qrSettings.style=="extra-rounded"?"selected":""}>Extra Rounded</option>
</select>
</div>

<div>
<label class="text-xs">Logo</label>
<input type="file" id="logoUpload"
accept="image/*"
class="w-full text-xs"
onchange="updateQRSettings()">
</div>

<div>
<label class="text-xs invisible">Remove</label>
<button type="button" onclick="removeLogo()"
class="w-full h-10 text-red-500 border rounded-lg text-xs">
Remove
</button>
</div>

</div>
</div>
`;
}
/* ---------- SAFE VALUE ---------- */
function val(id){
const el=document.getElementById(id);
return el?el.value:"";
}

/* ---------- AUTO ---------- */
function autoQR(){ generateQR(); }

/* ---------- QR GENERATION ---------- */
function generateQR(){

try{

let data={};
QR_TYPES[currentType].fields.forEach(f=>{
 data[f.id]=val(f.id);
});

let qrText = buildQRData(currentType,data);

/* ---- FIX: sanitize QR data ---- */
if(qrText===undefined || qrText===null) qrText="";
qrText = String(qrText).trim();

/* convert real line breaks → QR safe */
qrText = qrText.replace(/\r?\n/g,"\\n");

const box = document.getElementById("qrcode");

/* CLEAR FIRST */
box.innerHTML="";
  
/* destroy old QR instance */
if(qrCode && typeof qrCode._options !== "undefined"){
  try{ qrCode._canvas?.remove(); }catch(e){}
  try{ qrCode._svg?.remove(); }catch(e){}
  qrCode=null;
}

/* If empty → show hint and STOP */
if(!qrText){
 box.innerHTML='<div class="text-gray-400 text-sm">Enter details to generate QR</div>';
 qrCode=null;
 return;
}

/* Only render when valid */
qrCode = renderQR(box, qrText, qrSettings);

}catch(e){
 console.log("QR error:",e);
}
}

function updateQRSettings(){
qrSettings.color=document.getElementById("qrColor")?.value || "#000000";
qrSettings.bg=document.getElementById("bgColor")?.value || "#ffffff";
qrSettings.style=document.getElementById("qrStyle")?.value || "square";

const file=document.getElementById("logoUpload")?.files[0];
if(qrSettings.logo) URL.revokeObjectURL(qrSettings.logo);
qrSettings.logo = file ? URL.createObjectURL(file) : null;

generateQR();
}
function removeLogo(){
qrSettings.logo=null;
const input=document.getElementById("logoUpload");
if(input) input.value="";
generateQR();
}


/* ---------- DOWNLOAD MODAL ---------- */
function openDownloadModal(){
if(!qrCode) return alert("Generate QR first");
document.getElementById("downloadModal").classList.remove("hidden");
document.getElementById("downloadModal").classList.add("flex");
}
function closeDownloadModal(){
document.getElementById("downloadModal").classList.add("hidden");
}

function downloadSelected(){
const size=parseInt(document.getElementById("qrSize").value);

qrCode.update({width:size,height:size});
qrCode.download({name:"qr-code",extension:"png"});
/* restore preview size */
qrCode.update({width:260,height:260});
closeDownloadModal();
}
/* ---------- SAVE MODAL ---------- */
function openSaveModal(){
if(!qrCode) return alert("Generate QR first");
document.getElementById("saveModal").classList.remove("hidden");
document.getElementById("saveModal").classList.add("flex");
}
function closeSaveModal(){
document.getElementById("saveModal").classList.add("hidden");
}
/* ---------- SAVE TO DASHBOARD ---------- */
function saveQR(){
const name=document.getElementById("qrFileName").value.trim();
if(!name) return alert("Enter file name");
/* prevent double click */
const btn=event.target;
btn.disabled=true;
btn.innerText="Saving...";
/* convert QR to image */
qrCode.getRawData("png").then(blob=>{
const reader=new FileReader();
reader.onload=function(){
let saved=JSON.parse(localStorage.getItem("savedQRs")||"[]");
saved.push({
name:name,
date:new Date().toLocaleString(),
data:reader.result
});
localStorage.setItem("savedQRs",JSON.stringify(saved));
/* clear input + close modal */
document.getElementById("qrFileName").value="";
closeSaveModal();
alert("QR saved to Dashboard");
/* restore button */
btn.disabled=false;
btn.innerText="Save";
};
reader.readAsDataURL(blob);
});
}

function initSlider(){
  const wrapper=document.getElementById("tabsWrapper");
  const tabs=document.getElementById("tabs");

  tabPosition=0;
  tabs.style.transform="translateX(0px)";

  const maxScroll=Math.max(0,tabs.scrollWidth-wrapper.clientWidth);

  document.getElementById("leftArrow").style.visibility="hidden";
  document.getElementById("rightArrow").style.visibility=
      maxScroll>5 ? "visible":"hidden";
}
/* ---------- PAGE INITIAL LOAD ---------- */
window.addEventListener("load",()=>{

 const waitEngine=setInterval(()=>{

   if(window.QR_TYPES && window.buildQRData){

     clearInterval(waitEngine);

     renderTabs();

     currentType=Object.keys(QR_TYPES)[0];
     renderForm();

     setTimeout(()=>{
       slideTabs(0);
     },120);

   }

 },50);

});

</script>
<!-- NAVBAR AUTH CONTROLLER (VERY IMPORTANT) -->
<script src="js/auth.js"></script>
<!-- DOWNLOAD MODAL -->
<div id="downloadModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
<div class="bg-white p-6 rounded-xl w-80 text-center">
<h3 class="font-semibold mb-4">Select Resolution</h3>

<select id="qrSize" class="w-full border rounded p-2 mb-4">
<option value="300">300 px (Small)</option>
<option value="600">600 px (Medium)</option>
<option value="1200">1200 px (HD)</option>
<option value="2000">2000 px (Print)</option>
</select>

<div class="flex gap-3">
<button onclick="downloadSelected()" class="bg-green-600 text-white px-4 py-2 rounded w-full">Download</button>
<button onclick="closeDownloadModal()" class="border px-4 py-2 rounded w-full">Cancel</button>
</div>
</div>
</div>
<!-- SAVE MODAL -->
<div id="saveModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
<div class="bg-white p-6 rounded-xl w-80 text-center">

<h3 class="font-semibold mb-4">Save QR</h3>

<input id="qrFileName" placeholder="Enter file name"
class="w-full border rounded p-2 mb-4">

<div class="flex gap-3">
<button onclick="saveQR()" class="bg-indigo-600 text-white px-4 py-2 rounded w-full">Save</button>
<button onclick="closeSaveModal()" class="border px-4 py-2 rounded w-full">Cancel</button>
</div>

</div>
</div>

</body>
</html>









































